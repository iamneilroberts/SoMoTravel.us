<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoMo Travel — Trips</title>
  <style>
    :root {
      --primary:#0d6efd; --primary-600:#0b5ed7; --muted:#6b7280; --text:#111827;
      --bg:#f6f7fb; --card:#ffffff; --border:#e5e7eb; --chip:#eef2ff; --chip-text:#334155;
      --radius:14px;
    }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text); background:var(--bg)}
    .container{max-width:1120px; margin:28px auto; padding:0 18px}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px}
    h1{font-size:22px; margin:0}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; background:#eef0f6}
    .btn-primary{background:var(--primary); color:#fff}
    .btn-primary:hover{background:var(--primary-600)}
    .btn-secondary{background:#e9ecf4}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .title{font-weight:700; margin-bottom:4px}
    .dates{color:var(--muted); font-size:13px}
    .status{display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#374151; font-size:12px; margin-top:8px}
    .tags{margin-top:8px}
    .tag{display:inline-block; padding:4px 8px; background:var(--chip); color:var(--chip-text); border-radius:999px; font-size:12px; margin-right:6px; margin-top:6px}
    .actions{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:13px}

    /* Modal */
    .backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:1000; align-items:center; justify-content:center}
    .modal{width:min(760px,95%); max-height:85vh; overflow:auto; background:#fff; border-radius:14px; border:1px solid var(--border); box-shadow:0 18px 46px rgba(0,0,0,.25)}
    .modal header{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .modal .content{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row>div{flex:1 1 220px}
    input[type="text"], select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px}
    .file-drop{border:2px dashed #cbd5e1; border-radius:12px; padding:16px; text-align:center; color:#64748b; background:#fafbff; cursor:pointer}

    /* Spinner overlay */
    #spinnerOverlay{display:none; position:fixed; inset:0; background:rgba(255,255,255,.85); z-index:2000; align-items:center; justify-content:center; flex-direction:column; color:#222}
    #spinnerOverlay .spinner{border:6px solid #f3f3f3; border-top:6px solid var(--primary); border-radius:50%; width:56px; height:56px; animation:spin 1s linear infinite; margin-bottom:1rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>SoMo Travel — Trips</h1>
      <div class="toolbar">
        <button class="btn" onclick="openAddModal()">Add Trip</button>
        <button class="btn" onclick="setToken()">Set GitHub Token</button>
        <button class="btn" onclick="openMetadataHistory()">Metadata History</button>
      </div>
    </header>

    <div id="tripGrid" class="grid"></div>
    <div id="emptyState" class="muted" style="display:none">No trips yet.</div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="tripModal" class="backdrop">
    <div class="modal">
      <header>
        <div class="title" id="modalTitle">Add Trip</div>
        <button class="btn" onclick="closeModal()">Close</button>
      </header>
      <div class="content">
        <form id="tripForm">
          <input type="hidden" id="editIndex" value="" />
          <div class="row">
            <div><label>Title<br><input id="tripTitle" type="text" required placeholder="e.g., Dublin & Paris Journey"></label></div>
            <div><label>Dates<br><input id="tripDates" type="text" placeholder="e.g., May 5–15, 2026"></label></div>
          </div>
          <div class="row">
            <div>
              <label>Category<br>
                <select id="tripCategory">
                  <option value="proposal">Travel Proposal</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="complete">Complete</option>
                </select>
              </label>
            </div>
            <div><label>Tags (comma separated)<br><input id="tripTags" type="text" placeholder="e.g., family, europe"></label></div>
          </div>
          <div class="row">
            <div><label>Filename (public .html)<br><input id="tripFilename" type="text" required placeholder="e.g., DublinParis2026.html"></label></div>
            <div style="display:flex; align-items:flex-end">
              <div id="fileDrop" class="file-drop" onclick="document.getElementById('htmlFile').click()">
                <input id="htmlFile" type="file" accept=".html,.htm" style="display:none">
                <div id="fileInfo">Click to choose itinerary HTML (or leave empty to only edit metadata)</div>
              </div>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
            <button id="submitBtn" type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Version History Modal (per file) -->
  <div id="historyModal" class="backdrop">
    <div class="modal">
      <header>
        <div>
          <div class="title">Version history</div>
          <div class="muted" id="historyPath"></div>
        </div>
        <button class="btn" onclick="closeHistoryModal()">Close</button>
      </header>
      <div id="historyBody" class="content">Loading…</div>
    </div>
  </div>

  <!-- Spinner overlay -->
  <div id="spinnerOverlay"><div class="spinner"></div><div id="spinnerMessage">Working…</div></div>

<script>
/***** CONFIG *****/
const GITHUB_CONFIG = { owner: 'iamneilroberts', repo: 'SoMoTravel.us', branch: 'main' };

/***** UTILITIES *****/
function showSpinner(msg='Working…'){ document.getElementById('spinnerMessage').textContent = msg; document.getElementById('spinnerOverlay').style.display='flex'; }
function hideSpinner(){ document.getElementById('spinnerOverlay').style.display='none'; }

function asciiHeaderValue(s){ return String(s ?? '').normalize('NFKC').replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]/g,' ').replace(/[^\x20-\x7E]/g,'').trim(); }
function sanitizeToken(raw){ let t = asciiHeaderValue(raw).replace(/^["']|["']$/g,''); const m = t.match(/gh[pousr]_[A-Za-z0-9_]+/); return m?m[0]:t; }
function getGitHubToken(){ let token = localStorage.getItem('github_token'); if(!token){ token = prompt('Enter GitHub Personal Access Token (repo contents read/write):'); } if(token){ token = sanitizeToken(token); localStorage.setItem('github_token', token); return token; } return null; }
function setToken(){ localStorage.removeItem('github_token'); getGitHubToken(); alert('Token stored.'); }

function encodeBase64(str){ try{ return btoa(unescape(encodeURIComponent(str))); }catch(e){ let out=''; for(let i=0;i<str.length;i++){ const c=str.charCodeAt(i); if(c<128) out+=String.fromCharCode(c); else if(c<2048) out+=String.fromCharCode(192|(c>>6))+String.fromCharCode(128|(c&63)); else out+=String.fromCharCode(224|(c>>12))+String.fromCharCode(128|((c>>6)&63))+String.fromCharCode(128|(c&63)); } return btoa(out);} }

async function waitForFile(url, attempts=6, delay=3000){ for(let i=0;i<attempts;i++){ try{ const r=await fetch(url+`?cb=${Date.now()}`, {cache:'reload'}); if(r.ok) return true; }catch(_){} await new Promise(r=>setTimeout(r,delay)); } return false; }
async function waitForRemoval(url, attempts=6, delay=3000){ for(let i=0;i<attempts;i++){ try{ const r=await fetch(url+`?cb=${Date.now()}`, {cache:'reload'}); if(!r.ok) return true; }catch(_){ return true; } await new Promise(r=>setTimeout(r,delay)); } return false; }

function parseTagsInput(str){ return (str||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,20); }

/***** PUBLIC LOAD (NO TOKEN) *****/
async function loadTripsPublic(){ const url = `${location.origin}/trips.json?cb=${Date.now()}`; const res = await fetch(url,{cache:'reload'}); if(!res.ok) { document.getElementById('tripGrid').innerHTML=''; document.getElementById('emptyState').style.display='block'; return []; } const data = await res.json(); const trips = Array.isArray(data.trips)?data.trips:[]; renderTrips(trips); return trips; }

/***** GITHUB HELPERS (ADMIN) *****/
function ghHeaders(){ const token=getGitHubToken(); if(!token) throw new Error('Missing token'); return { 'Authorization': asciiHeaderValue('Bearer '+token), 'Accept':'application/vnd.github.v3+json', 'Content-Type':'application/json' }; }

async function uploadToGitHub(filename, content){ const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`; const headers=ghHeaders(); let sha=null; try{ const chk=await fetch(url+`?ref=${GITHUB_CONFIG.branch}`,{headers}); if(chk.ok){ const j=await chk.json(); sha=j.sha||null; } }catch(_){} const resp=await fetch(url,{ method:'PUT', headers, body: JSON.stringify({ message:(sha?`Update travel document: ${filename}`:`Add travel document: ${filename}`), content: encodeBase64(content), branch:GITHUB_CONFIG.branch, ...(sha?{sha}:{} ) }) }); if(!resp.ok){ let msg=`HTTP ${resp.status}`; try{ const j=await resp.json(); if(j?.message) msg+=` - ${j.message}`; }catch(_){} throw new Error(msg); } }

async function deleteFromGitHub(filename){ const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`; const headers=ghHeaders(); const head=await fetch(url+`?ref=${GITHUB_CONFIG.branch}`,{headers}); if(!head.ok) throw new Error('Lookup failed '+head.status); const j=await head.json(); const del=await fetch(url,{method:'DELETE', headers, body: JSON.stringify({ message:`Delete ${filename}`, sha:j.sha, branch:GITHUB_CONFIG.branch })}); if(!del.ok){ let msg=`HTTP ${del.status}`; try{ const d=await del.json(); if(d?.message) msg+=` - ${d.message}`; }catch(_){} throw new Error(msg);} }

async function getTripsJsonFromGitHub(){ const headers=ghHeaders(); const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/trips.json?ref=${GITHUB_CONFIG.branch}`; const res=await fetch(url,{headers}); if(res.status===404) return {sha:null,trips:[]}; if(!res.ok) throw new Error('trips.json GET '+res.status); const j=await res.json(); const text=atob((j.content||'').replace(/\n/g,'')); const data=JSON.parse(text||'{"version":1,"trips":[]}'); return { sha:j.sha||null, trips:Array.isArray(data.trips)?data.trips:[] } }

async function saveTripsJsonToGitHub(nextTrips, prevSha){ const headers=ghHeaders(); const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/trips.json`; const body={ message:'Update trips.json', content: encodeBase64(JSON.stringify({version:1,trips:nextTrips},null,2)), branch:GITHUB_CONFIG.branch, ...(prevSha?{sha:prevSha}:{}) }; const put=await fetch(url,{method:'PUT', headers, body:JSON.stringify(body)}); if(!put.ok){ let msg=`trips.json PUT ${put.status}`; try{ const j=await put.json(); if(j?.message) msg+=` - ${j.message}`; }catch(_){} throw new Error(msg);} }

/***** RENDER *****/
function renderTrips(trips){ const grid=document.getElementById('tripGrid'); grid.innerHTML=''; document.getElementById('emptyState').style.display=trips.length? 'none':'block'; trips.forEach((t,i)=> grid.appendChild(createTripCard(t,i))); }

function createTripCard(trip, index){ const card=document.createElement('div'); card.className='card trip-card'; const title=document.createElement('div'); title.className='title'; title.textContent=trip.title||trip.filename; const dates=document.createElement('div'); dates.className='dates'; dates.textContent=trip.dates||''; const status=document.createElement('div'); status.className='status'; status.textContent=(trip.category||'proposal').replace(/^./,c=>c.toUpperCase()); const tags=document.createElement('div'); tags.className='tags'; (trip.tags||[]).forEach(t=>{ const el=document.createElement('span'); el.className='tag'; el.textContent=t; tags.appendChild(el); }); const view=document.createElement('a'); view.href=`/${trip.filename}`; view.target='_blank'; view.rel='noopener'; view.className='btn btn-secondary'; view.textContent='View'; const histBtn=document.createElement('button'); histBtn.className='btn btn-secondary'; histBtn.textContent='Version history'; histBtn.onclick=()=>openHistoryModal(trip);
  const editBtn=document.createElement('button'); editBtn.className='btn btn-secondary'; editBtn.textContent='Edit'; editBtn.onclick=()=>openEditModal(trip,index);
  const delBtn=document.createElement('button'); delBtn.className='btn btn-secondary'; delBtn.textContent='Delete'; delBtn.onclick=()=>confirmDeleteTrip(trip,index);
  const actions=document.createElement('div'); actions.className='actions'; actions.append(view,histBtn,editBtn,delBtn);
  card.append(title,dates,status,tags,actions); return card; }

/***** MODALS *****/
function openAddModal(){ document.getElementById('tripForm').reset(); document.getElementById('editIndex').value=''; document.getElementById('modalTitle').textContent='Add Trip'; document.getElementById('fileInfo').textContent='Click to choose itinerary HTML'; document.getElementById('tripModal').style.display='flex'; }
function openEditModal(trip,index){ document.getElementById('modalTitle').textContent='Edit Trip'; document.getElementById('tripTitle').value=trip.title||''; document.getElementById('tripDates').value=trip.dates||''; document.getElementById('tripCategory').value=trip.category||'proposal'; document.getElementById('tripTags').value=(trip.tags||[]).join(', '); document.getElementById('tripFilename').value=trip.filename||''; document.getElementById('fileInfo').textContent='(Optional) choose a new HTML to replace existing'; document.getElementById('editIndex').value=String(index); document.getElementById('tripModal').style.display='flex'; }
function closeModal(){ document.getElementById('tripModal').style.display='none'; }

/***** ADD/EDIT SUBMIT *****/
(function initForm(){ const inp=document.getElementById('htmlFile'); inp.addEventListener('change',()=>{ const f=inp.files?.[0]; document.getElementById('fileInfo').textContent = f? `Selected: ${f.name}` : 'Click to choose itinerary HTML'; }); document.getElementById('tripForm').addEventListener('submit', onSubmitTrip); })();

async function onSubmitTrip(e){ e.preventDefault(); try{
  const i = document.getElementById('editIndex').value; const isEdit = i!==''; const title=document.getElementById('tripTitle').value.trim(); const dates=document.getElementById('tripDates').value.trim(); const category=document.getElementById('tripCategory').value; const tags=parseTagsInput(document.getElementById('tripTags').value); const filename=document.getElementById('tripFilename').value.trim();
  let fileContent=null; const fileInput=document.getElementById('htmlFile'); if(fileInput.files && fileInput.files[0]){ fileContent= await fileInput.files[0].text(); }

  // 1) Upload/replace file if provided
  if(fileContent!==null){ showSpinner('Uploading itinerary…'); await uploadToGitHub(filename, fileContent); const fileUrl=`${location.origin}/${filename}`; await waitForFile(fileUrl); hideSpinner(); }

  // 2) Update trips.json
  showSpinner('Updating metadata…'); const {sha,trips}= await getTripsJsonFromGitHub(); const idx = trips.findIndex(t=>t.filename===filename); const entry={ filename, title, dates, category, tags, lastModified: new Date().toISOString().slice(0,10) };
  if(idx>=0){ trips[idx]=entry; } else { trips.push(entry); }
  await saveTripsJsonToGitHub(trips, sha); await waitForFile(`${location.origin}/trips.json`); hideSpinner(); alert('Saved.'); closeModal(); await loadTripsPublic(); }
  catch(err){ hideSpinner(); console.error(err); alert('Save failed: '+(err?.message||err)); }
}

/***** DELETE *****/
async function confirmDeleteTrip(trip,index){ if(!confirm(`Delete ${trip.title||trip.filename}?`)) return; try{ showSpinner('Deleting…'); await deleteFromGitHub(trip.filename); await waitForRemoval(`${location.origin}/${trip.filename}`); const {sha,trips}=await getTripsJsonFromGitHub(); const next=trips.filter(t=>t.filename!==trip.filename); await saveTripsJsonToGitHub(next, sha); await waitForFile(`${location.origin}/trips.json`); hideSpinner(); alert('Deleted.'); await loadTripsPublic(); } catch(err){ hideSpinner(); console.error(err); alert('Delete failed: '+(err?.message||err)); } }

/***** FILE HISTORY (for itinerary) *****/
function closeHistoryModal(){ document.getElementById('historyModal').style.display='none'; document.getElementById('historyBody').innerHTML=''; }
async function listFileHistory(path, perPage=25){ const headers=ghHeaders(); const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(path)}&per_page=${perPage}&sha=${encodeURIComponent(GITHUB_CONFIG.branch)}`; const r=await fetch(url,{headers}); if(!r.ok) throw new Error('History HTTP '+r.status); return r.json(); }
function previewHistorical(path,sha){ const raw=`https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${sha}/${path}`; window.open(raw,'_blank','noopener'); }
async function restoreFileToCommit(path,sha){ const headers=ghHeaders(); const head=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}?ref=${GITHUB_CONFIG.branch}`,{headers}); if(!head.ok) throw new Error('Head lookup '+head.status); const headJ=await head.json(); const hist=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}?ref=${sha}`,{headers}); if(!hist.ok) throw new Error('Historical lookup '+hist.status); const histJ=await hist.json(); const put=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,{ method:'PUT', headers, body: JSON.stringify({ message:`Revert ${path} to ${sha}`, content: histJ.content, branch:GITHUB_CONFIG.branch, sha: headJ.sha }) }); if(!put.ok){ let m=`HTTP ${put.status}`; try{ const j=await put.json(); if(j?.message) m+=` - ${j.message}`; }catch(_){} throw new Error(m);} }

async function openHistoryModal(trip){ const modal=document.getElementById('historyModal'); const body=document.getElementById('historyBody'); document.getElementById('historyPath').textContent=trip.filename; body.innerHTML='Loading…'; modal.style.display='flex'; try{ const commits=await listFileHistory(trip.filename,30); if(!Array.isArray(commits)||!commits.length){ body.innerHTML='<div class="muted">No history.</div>'; return; } const wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gap='10px'; commits.forEach(c=>{ const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='10px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const when=new Date(c.commit.author.date).toLocaleString(); row.innerHTML=`<div><div style="font-weight:600">${when}</div><div class="muted">${(c.commit.message||'').split('\n')[0]}</div><div class="muted" style="font-size:12px">${c.sha.slice(0,7)}</div></div>`; const prev=document.createElement('button'); prev.className='btn btn-secondary'; prev.textContent='Preview'; prev.onclick=()=>previewHistorical(trip.filename,c.sha); const restore=document.createElement('button'); restore.className='btn btn-primary'; restore.textContent='Restore'; restore.onclick=async()=>{ if(!confirm(`Restore ${trip.filename} to ${c.sha.slice(0,7)}?`)) return; try{ showSpinner('Restoring…'); await restoreFileToCommit(trip.filename,c.sha); await waitForFile(`${location.origin}/${trip.filename}`); hideSpinner(); alert('Restored.'); }catch(err){ hideSpinner(); alert('Restore failed: '+(err?.message||err)); } }; row.append(prev,restore); wrap.appendChild(row); }); body.innerHTML=''; body.appendChild(wrap); }catch(err){ console.error(err); body.innerHTML='<div style="color:#b00">Failed to load history.</div>'; } }

/***** METADATA (trips.json) HISTORY (global) *****/
async function openMetadataHistory(){ try{ const headers=ghHeaders(); const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=trips.json&per_page=30&sha=${encodeURIComponent(GITHUB_CONFIG.branch)}`; const r=await fetch(url,{headers}); if(!r.ok) throw new Error('HTTP '+r.status); const commits=await r.json(); const bodyEl=document.createElement('div'); bodyEl.className='content'; const list=document.createElement('div'); list.style.display='grid'; list.style.gap='10px'; (commits||[]).forEach(c=>{ const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='10px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const when=new Date(c.commit.author.date).toLocaleString(); row.innerHTML=`<div><div style="font-weight:600">${when}</div><div class="muted">${(c.commit.message||'').split('\n')[0]}</div><div class="muted" style="font-size:12px">${c.sha.slice(0,7)}</div></div>`; const prev=document.createElement('button'); prev.className='btn btn-secondary'; prev.textContent='Preview'; prev.onclick=()=>window.open(`https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${c.sha}/trips.json`,'_blank','noopener'); const restore=document.createElement('button'); restore.className='btn btn-primary'; restore.textContent='Restore'; restore.onclick=()=>restoreTripsJsonToCommit(c.sha); row.append(prev,restore); list.appendChild(row); }); const modal=document.getElementById('historyModal'); document.getElementById('historyPath').textContent='trips.json'; const hb=document.getElementById('historyBody'); hb.innerHTML=''; hb.appendChild(list); modal.style.display='flex'; }catch(err){ alert('Failed to load metadata history: '+(err?.message||err)); } }

async function restoreTripsJsonToCommit(sha){ if(!confirm(`Restore trips.json to ${sha.slice(0,7)}?`)) return; try{ showSpinner('Restoring metadata…'); const headers=ghHeaders(); const head=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/trips.json?ref=${GITHUB_CONFIG.branch}`,{headers}); if(!head.ok) throw new Error('Head lookup '+head.status); const headJ=await head.json(); const hist=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/trips.json?ref=${sha}`,{headers}); if(!hist.ok) throw new Error('Historical lookup '+hist.status); const histJ=await hist.json(); const put=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/trips.json`,{ method:'PUT', headers, body: JSON.stringify({ message:`Revert trips.json to ${sha}`, content: histJ.content, branch:GITHUB_CONFIG.branch, sha: headJ.sha })}); if(!put.ok) throw new Error('PUT '+put.status); await waitForFile(`${location.origin}/trips.json`); hideSpinner(); alert('Metadata restored.'); await loadTripsPublic(); }catch(err){ hideSpinner(); alert('Restore failed: '+(err?.message||err)); }
}

/***** STARTUP *****/
loadTripsPublic();
</script>
</body>
</html>
